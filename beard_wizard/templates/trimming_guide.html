<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trimming Guide - Beard Wizard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        /* Style for the video and canvas container */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            aspect-ratio: 4 / 3;
            margin: auto;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
            border: 2px solid #374151; /* border-gray-700 */
        }
        #webcam, #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Flip horizontally to create a mirror effect */
            transform: scaleX(-1);
        }
    </style>
</head>
<body class="text-gray-200">

    <header class="py-6 px-4 sm:px-6 lg:px-8">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tighter text-white">
                Live <span class="text-amber-400">Guide</span>
            </h1>
            <nav>
                <a href="index.html" class="text-gray-400 hover:text-amber-400 transition-colors duration-300 font-medium">
                    &larr; Back to Home
                </a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="lg:grid lg:grid-cols-3 lg:gap-8">
            
            <div class="lg:col-span-2">
                <div id="loading-message" class="text-center p-8 bg-gray-800 rounded-xl">
                    <p class="text-lg">Initializing Camera...</p>
                    <p class="text-sm text-gray-400">Please allow camera access when prompted.</p>
                </div>
                <div class="video-container hidden">
                    <video id="webcam" autoplay playsinline></video>
                    <canvas id="overlayCanvas"></canvas>
                </div>
            </div>

            <aside class="mt-8 lg:mt-0">
                <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-4">Controls</h3>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Beard Style</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="style-low-boxed" onclick="selectStyle('low_boxed')" class="style-button bg-amber-500 text-gray-900 font-semibold py-2 px-4 rounded-lg text-sm transition-all">
                                Low Boxed
                            </button>
                            <button id="style-full-beard" onclick="selectStyle('full_beard')" class="style-button bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-all">
                                Full Beard
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label for="opacity-slider" class="block text-sm font-medium text-gray-400 mb-2">Line Opacity</label>
                        <input id="opacity-slider" type="range" min="0.1" max="1.0" value="0.9" step="0.1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                
                <div class="mt-4 text-xs text-gray-500 p-4 text-center">
                    <p>Turn your head to see how the 3D guide lines disappear on the far side.</p>
                </div>
            </aside>
        </div>
    </main>

    <script>
        // --- DOM ELEMENTS ---
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('overlayCanvas');
        const canvasCtx = canvasElement.getContext('2d');
        const opacitySlider = document.getElementById('opacity-slider');
        const loadingMessage = document.getElementById('loading-message');
        const videoContainer = document.querySelector('.video-container');

        // --- BEARD STYLE DEFINITIONS ---
        const BEARD_STYLES = {
            low_boxed: [
                [70, 118, 117, 111, 62, 58, 172, 136, 150, 149, 176, 148, 152, 377, 400, 378, 379, 365, 397, 288, 292, 340, 346, 347, 300], // Main outline
                [61, 40, 37, 0, 267, 270, 291, 321, 405, 314, 17, 84, 181, 91, 146], // Mustache
                [18, 85, 86, 16, 316, 315] // Soul Patch
            ],
            full_beard: [
                [127, 234, 93, 132, 58, 172, 136, 150, 149, 176, 148, 152, 377, 400, 378, 379, 365, 397, 288, 361, 323, 454, 356], // Main outline
                [61, 185, 40, 39, 37, 0, 267, 269, 270, 409, 291, 321, 405, 314, 17, 84, 181, 91, 146] // Full Mustache
            ]
        };
        let activeStyle = BEARD_STYLES.low_boxed;

        // --- WEBCAM AND MEDIAPIPE SETUP ---
        const faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults(onResults);

        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
            .then((stream) => {
                videoElement.srcObject = stream;
                videoElement.addEventListener('loadedmetadata', () => {
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    loadingMessage.classList.add('hidden');
                    videoContainer.classList.remove('hidden');
                    
                    // Start processing frames
                    const processFrames = () => {
                        if (videoElement.readyState >= 2) {
                            faceMesh.send({ image: videoElement });
                        }
                        requestAnimationFrame(processFrames);
                    };
                    processFrames();
                });
            })
            .catch((err) => {
                console.error("Error accessing webcam: ", err);
                loadingMessage.innerHTML = `<p class="text-lg text-red-400">Error: Could not access camera.</p><p class="text-sm text-gray-400">Please check permissions and refresh the page.</p>`;
            });

        // --- DRAWING LOGIC ---
        function onResults(results) {
            const w = canvasElement.width;
            const h = canvasElement.height;
            
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, w, h);
            canvasCtx.globalAlpha = opacitySlider.value; // Apply transparency
            canvasCtx.strokeStyle = "#FBBF24"; // amber-400
            canvasCtx.lineWidth = 3;

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                const numLandmarks = landmarks.length;
                const Z_THRESHOLD = 0.05; // Adjust this for occlusion sensitivity

                for (const shape of activeStyle) {
                    canvasCtx.beginPath();
                    for (let i = 0; i < shape.length; i++) {
                        const p1_idx = shape[i];
                        const p2_idx = shape[(i + 1) % shape.length]; // Wrap around for closed loop

                        if (p1_idx < numLandmarks && p2_idx < numLandmarks) {
                            const p1 = landmarks[p1_idx];
                            const p2 = landmarks[p2_idx];

                            // Occlusion Check: Draw line only if both points are facing camera
                            if (p1.z < Z_THRESHOLD && p2.z < Z_THRESHOLD) {
                                canvasCtx.moveTo(p1.x * w, p1.y * h);
                                canvasCtx.lineTo(p2.x * w, p2.y * h);
                            }
                        }
                    }
                    canvasCtx.stroke();
                }
            }
            canvasCtx.restore();
        }

        // --- CONTROL PANEL LOGIC ---
        function selectStyle(styleName) {
            activeStyle = BEARD_STYLES[styleName];
            
            // Update button styles
            document.querySelectorAll('.style-button').forEach(button => {
                button.classList.remove('bg-amber-500', 'text-gray-900');
                button.classList.add('bg-gray-700', 'text-white');
            });
            
            const selectedButton = document.getElementById(`style-${styleName.replace(/_/g, '-')}`);
            selectedButton.classList.add('bg-amber-500', 'text-gray-900');
            selectedButton.classList.remove('bg-gray-700', 'text-white');
        }
    </script>

</body>
</html>
