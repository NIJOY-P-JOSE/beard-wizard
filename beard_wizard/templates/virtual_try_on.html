{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Try-On - Beard Wizard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .video-container { position: relative; width: 100%; max-width: 800px; aspect-ratio: 4 / 3; margin: auto; border-radius: 0.75rem; overflow: hidden; border: 2px solid #374151; }
        #webcam, #overlayCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
    </style>
</head>
<body class="text-gray-200">

    <header class="py-6 px-4 sm:px-6 lg:px-8">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tighter text-white">Virtual <span class="text-amber-400">Try-On</span></h1>
            <nav>
                <a href="{% url 'home' %}" class="text-gray-400 hover:text-amber-400 transition-colors duration-300 font-medium">&larr; Back to Home</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="lg:grid lg:grid-cols-3 lg:gap-8">
            <div class="lg:col-span-2">
                <div id="loading-message" class="text-center p-8 bg-gray-800 rounded-xl">
                    <p class="text-lg">Initializing Camera & AI Model...</p>
                </div>
                <div class="video-container hidden">
                    <video id="webcam" autoplay playsinline></video>
                    <canvas id="overlayCanvas"></canvas>
                </div>
            </div>

            <aside class="mt-8 lg:mt-0">
                <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-4">Choose a Style</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Style Buttons -->
                        <button onclick="selectStyle('balbo')" class="style-button bg-amber-500 text-gray-900 font-semibold py-2 px-4 rounded-lg text-sm transition-all">Balbo</button>
                        <button onclick="selectStyle('van_dyke')" class="style-button bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-all">Van Dyke</button>
                        <button onclick="selectStyle('goatee')" class="style-button bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-all">Goatee</button>
                        <button onclick="selectStyle('none')" class="style-button bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-all">None</button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <script type="module">
        import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js";

        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('overlayCanvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingMessage = document.getElementById('loading-message');
        const videoContainer = document.querySelector('.video-container');

        let faceLandmarker;
        let lastVideoTime = -1;
        let activeStyleName = 'balbo';

        // Preload beard images
        const BEARD_IMAGES = {
            balbo: { src: "{% static 'assets/balbo.png' %}", img: new Image(), offset: -0.05, scale: 1.4 },
            van_dyke: { src: "{% static 'assets/van_dyke.png' %}", img: new Image(), offset: -0.05, scale: 1.5 },
            goatee: { src: "{% static 'assets/goatee.png' %}", img: new Image(), offset: -0.02, scale: 1.2 },
            none: { src: null, img: null }
        };

        for (const key in BEARD_IMAGES) {
            if (BEARD_IMAGES[key].src) {
                BEARD_IMAGES[key].img.src = BEARD_IMAGES[key].src;
            }
        }

        async function setup() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`, delegate: "GPU" },
                runningMode: "VIDEO",
                numFaces: 1
            });
            startWebcam();
        }

        function startWebcam() {
            navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } })
                .then(stream => {
                    videoElement.srcObject = stream;
                    videoElement.addEventListener("loadeddata", predictWebcam);
                })
                .catch(err => {
                    loadingMessage.innerHTML = `<p class="text-lg text-red-400">Camera Error</p>`;
                });
        }

        async function predictWebcam() {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            loadingMessage.classList.add('hidden');
            videoContainer.classList.remove('hidden');

            if (lastVideoTime !== videoElement.currentTime) {
                lastVideoTime = videoElement.currentTime;
                const results = faceLandmarker.detectForVideo(videoElement, performance.now());
                drawBeardOverlay(results);
            }
            window.requestAnimationFrame(predictWebcam);
        }

        function drawBeardOverlay(results) {
            const w = canvasElement.width;
            const h = canvasElement.height;
            canvasCtx.clearRect(0, 0, w, h);

            if (results.faceLandmarks && results.faceLandmarks.length > 0 && activeStyleName !== 'none') {
                const landmarks = results.faceLandmarks[0];
                const style = BEARD_IMAGES[activeStyleName];
                if (!style.img || !style.img.complete || style.img.naturalHeight === 0) {
                    return; // Don't draw if image isn't loaded
                }

                // Key landmarks for positioning
                const chin = landmarks[152];
                const leftJaw = landmarks[378];
                const rightJaw = landmarks[149];
                
                // Calculate position, rotation, and scale
                const beardWidth = Math.hypot((leftJaw.x - rightJaw.x) * w, (leftJaw.y - rightJaw.y) * h) * style.scale;
                const angle = Math.atan2((rightJaw.y - leftJaw.y) * h, (rightJaw.x - leftJaw.x) * w);
                
                const centerX = chin.x * w;
                const centerY = (chin.y + style.offset) * h;

                const finalHeight = (style.img.height / style.img.width) * beardWidth;

                canvasCtx.save();
                canvasCtx.translate(centerX, centerY);
                canvasCtx.rotate(angle);
                canvasCtx.drawImage(style.img, -beardWidth / 2, -finalHeight / 2, beardWidth, finalHeight);
                canvasCtx.restore();
            }
        }

        window.selectStyle = function(styleName) {
            activeStyleName = styleName;
            document.querySelectorAll('.style-button').forEach(button => {
                button.classList.remove('bg-amber-500', 'text-gray-900');
                button.classList.add('bg-gray-700', 'text-white');
            });
            const selectedButton = event.target;
            selectedButton.classList.add('bg-amber-500', 'text-gray-900');
            selectedButton.classList.remove('bg-gray-700', 'text-white');
        }

        setup();
    </script>
</body>
</html>
